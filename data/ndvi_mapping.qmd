---
title: "üåø NDVI over O ªahu with Sentinel-2 (R Tutorial)"
subtitle: "From Copernicus Browser to NDVI map in minutes"
author: "Your Name"
format:
  html:
    theme: cosmo
    toc: true
    toc-title: "On this page"
    toc-depth: 3
execute:
  echo: true
  message: false
  warning: false
editor: visual
---

```{r}
library(here)
library(terra)
library(sf)
library(mapview)
library(tidyverse)
```

## NDVI (Normalized Difference Vegetation Index)

NDVI is a simple, per-pixel indicator of ‚Äúgreenness‚Äù (photosynthetic activity).

### What it measures

Plants reflect more **near-infrared (NIR)** light and absorb **red** light. NDVI combines those two bands to highlight living vegetation.

### Formula

$$
\mathrm{NDVI} \;=\; \frac{\text{NIR} - \text{Red}}{\text{NIR} + \text{Red}}
$$

```{=html}
<!-- Plain-text fallback (if math is disabled):
NDVI = (NIR - Red) / (NIR + Red)
-->
```

### Typical value ranges

-   **0.6‚Äì0.9**: dense, healthy vegetation\
-   **0.2‚Äì0.5**: sparse/brown vegetation, shrubs/grass\
-   **0‚Äì0.2**: bare soil / urban\
-   **\< 0**: water, clouds, shadows, snow

### What data do we need to calculate NDVI

-   We can use the [Copernicus Open Access Hub](https://browser.dataspace.copernicus.eu/) to grab data form the satellite Sentinel 2

-   We specifically need Band 8 data for near-infared and Band 4 data for red

```{r}
# Paths to your .jp2 files
red_path <- here("data/band_data/T04QFJ_20250906T210919_B04_10m.jp2")
nir_path <- here("data/band_data/T04QFJ_20250906T210919_B08_10m.jp2")
```

### These .jp2 files contain raster data

-   Raster data is a way to represent geography as a **grid of cells (pixels)**. Each cell has a single value (e.g., elevation, temperature, NDVI) and the whole grid is georeferenced so every cell aligns to a real-world location

-   The `terra` package helps us read raster data into R

```{r}
# Read bands directly
red <- rast(red_path)
nir <- rast(nir_path)
```

### Calculating NDVI

$$
\mathrm{NDVI} \;=\; \frac{\text{NIR} - \text{Red}}{\text{NIR} + \text{Red}}
$$

```{r}
ndvi <- (nir - red) / (nir + red)
```

### Plotting NDVI

```{r}
plot(ndvi, main = "NDVI")
```

### Trimming the plot:

```{r}
# Create extent in lat/lon
oahu_ext_latlon <- ext(-158.3, -157.6, 21.2, 21.7)

# Create a temporary raster with this extent in WGS84
temp_raster <- rast(oahu_ext_latlon, crs = "EPSG:4326")

# Project to match your NDVI's CRS
temp_raster_utm <- project(temp_raster, crs(ndvi))

# Get the extent in UTM coordinates
oahu_bbox <- ext(temp_raster_utm)

# Crop your NDVI
ndvi_oahu <- crop(ndvi, oahu_bbox)
plot(ndvi_oahu, main = "NDVI - Oahu Area")
```

### Advanced Mapping

```{r}
# Reduce resolution significantly (factor of 8-10 should work)
ndvi_small <- aggregate(ndvi_oahu, fact = 4, fun = mean)

# Create custom breaks and colors
breaks <- c(-1, 0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 1)
colors <- c("#4A90E2",      # Ocean (blue)
           "#CD853F",       # Bare soil/urban (tan)
           "#DEB887",       # Very sparse (light tan)
           "#F0E68C",       # Sparse (light yellow)
           "#ADFF2F",       # Moderate (yellow-green)
           "#32CD32",       # Good vegetation (lime green)
           "#228B22",       # Dense vegetation (forest green)
           "#006400")       # Very dense (dark green)

mapview(ndvi_small,
        at = breaks,
        col.regions = colors,
        layer.name = "NDVI",
        alpha = 0.8)
```

## Challenge

1.  Can you use an AI assistant to write R code below that calculates the percentages of each of these groups listed below in our image? Make a bar blot with `ggplot` showing the percentage for each group.

    ```{r}
    # --- Challenge 1: Horizontal bar chart with colors ---

    ggplot(counts |> filter(ndvi_group != "Other (0.5‚Äì0.6 or >0.9)"),
           aes(y = ndvi_group, x = pct, fill = ndvi_group)) +
      geom_col() +
      geom_text(aes(label = pct_label), hjust = -0.1, size = 3.5) +
      scale_fill_manual(values = category_colors, guide = "none") +
      scale_x_continuous(labels = percent_format(), expand = expansion(mult = c(0, 0.08))) +
      labs(
        title = "NDVI categories across O ªahu subset",
        subtitle = "Share of pixels in each category (excluding 'Other')",
        x = "Percent of pixels", y = NULL
      ) +
      theme_minimal(base_size = 12)


    ```

-   **0.6‚Äì0.9**: dense, healthy vegetation
-   **0.2‚Äì0.5**: sparse/brown vegetation, shrubs/grass
-   **0‚Äì0.2**: bare soil / urban
-   **\< 0**: water, clouds, shadows, snow

2.  Find a research paper that utilizes NDVI to do something cool, paste a link to the paper below with a 3 sentence summary of how the paper uses NDVI

<https://www.mdpi.com/1999-4907/12/5/594>

-   The study uses long-term satellite-derived NDVI (from 1982 to 2012) to assess how vegetation activity responds to changes in extreme precipitation events in the Middle & Lower Reaches of the Yangtze River, China

-   It compares three NDVI-based indices (minimum, mean, and **maximum** NDVI) and finds that the **maximum NDVI** correlates most strongly with the **intensity** of extreme precipitation, better than minimum or mean NDVI

-   The results show not only a general increase of extreme precipitation events over time, but also spatial differences in how vegetation responds, suggesting that maximum NDVI is especially useful for detecting and mapping vegetation‚Äôs response to intense precipitation events\
